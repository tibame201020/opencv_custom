import React, { useState, useCallback, useMemo, useEffect, useRef } from 'react';
import {
    ReactFlow,
    MiniMap,
    Controls,
    Background,
    useNodesState,
    useEdgesState,
    addEdge,
    useReactFlow,
    ReactFlowProvider,
    type Connection,
    type Edge,
    type Node,
    type OnConnectEnd,
    type OnConnectStart,
    Handle,
    Position,
    NodeResizer,
    type NodeProps,
} from '@xyflow/react';
import '@xyflow/react/dist/style.css';
import Editor from '@monaco-editor/react';
import { useAppStore, type WorkflowTab } from '../store';
import {
    Trash2, ChevronDown, X, GripVertical, Plus,
    Braces, ToggleLeft, Play, Maximize,
    Focus, Minus, Check, Loader2, AlertCircle
} from 'lucide-react';
import clsx from 'clsx';
import { v4 as uuidv4 } from 'uuid';
import {
    NODE_DEFINITIONS, getNodeDef, getNodesByCategory, getDefaultConfig,
    CATEGORY_LABELS, CATEGORY_COLORS,
    type NodeCategory, type ParamSchema
} from '../workflow/nodeRegistry';

/* ============================================================
 *  Generic Node Component (driven by NodeRegistry)
 * ============================================================ */
const RESIZER_LINE_STYLE = { borderWidth: 0 };
const PAN_ON_DRAG = [2];
const DEFAULT_EDGE_OPTIONS = {
    type: 'smoothstep' as const,
    animated: true,
    style: { strokeWidth: 3, stroke: '#94a3b8' },
    interactionWidth: 20
};

const GenericNode = React.memo(({ data, id, type, selected }: NodeProps<any>) => {
    const def = getNodeDef(type || data.nodeType || 'click');
    const IconComp = def?.icon;
    const borderColor = selected ? 'border-primary' : 'border-base-300';

    // Status Logic
    const isRunning = data.status === 'running';
    const isSuccess = data.status === 'success';
    const isError = data.status === 'error';

    // n8n Style Soft Shadow
    const shadowStyle = {
        boxShadow: selected
            ? '0 0 0 2px rgba(var(--p), 0.2), 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)'
            : '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)'
    };

    return (
        <div
            className={clsx(
                "rounded-xl bg-base-100 border-[1.5px] min-w-[180px] relative group overflow-hidden transition-all duration-200 n8n-node-enter",
                borderColor,
                !selected && "hover:border-primary/50",
                isRunning && "n8n-node-running"
            )}
            style={shadowStyle}
        >
            <NodeResizer
                isVisible={selected}
                minWidth={120}
                minHeight={60}
                lineStyle={RESIZER_LINE_STYLE}
                lineClassName="border-transparent"
                handleClassName="h-3 w-3 bg-primary border-2 border-base-100 rounded-full shadow-md"
            />

            {/* Status Overlay */}
            {isSuccess && (
                <div className="absolute top-2 right-2 bg-success text-success-content rounded-full p-0.5 z-20 shadow-sm animate-in zoom-in duration-300">
                    <Check size={10} strokeWidth={3} />
                </div>
            )}
            {isError && (
                <div className="absolute top-2 right-2 bg-error text-error-content rounded-full p-0.5 z-20 shadow-sm animate-in zoom-in duration-300">
                    <AlertCircle size={10} strokeWidth={3} />
                </div>
            )}
            {isRunning && (
                <div className="absolute top-2 right-2 bg-primary text-primary-content rounded-full p-0.5 z-20 shadow-sm animate-spin duration-1000">
                    <Loader2 size={10} strokeWidth={3} />
                </div>
            )}

            {/* Header: Icon + Label */}
            <div className="flex items-center gap-2.5 px-3.5 py-3 bg-base-200/30 border-b border-base-200 pointer-events-none">
                <div className={clsx(
                    "p-1.5 rounded-lg flex-shrink-0 shadow-sm",
                    def ? `bg-${def.color}/10 text-${def.color}` : "bg-base-200 text-base-content"
                )}>
                    {IconComp && <IconComp size={16} />}
                </div>
                <div className="text-[13px] font-bold tracking-tight truncate text-base-content/90">
                    {data.label || def?.label || 'Node'}
                </div>
            </div>

            {/* Body: Config Snippet */}
            <div className="px-3.5 py-2.5 minimal-scrollbar overflow-hidden pointer-events-none bg-base-100">
                {data.subtitle ? (
                    <div className="text-[10px] text-base-content/60 font-medium truncate uppercase tracking-tighter">
                        {data.subtitle}
                    </div>
                ) : (
                    <div className="text-[11px] text-base-content/30 italic">Not configured</div>
                )}
            </div>

            {/* Target Handle (Left) */}
            <Handle
                type="target"
                position={Position.Left}
                className="w-2.5 h-2.5 !bg-base-100 border-2 border-primary !-left-1.5 transition-all hover:scale-125 hover:border-primary-focus shadow-sm"
            />

            {/* Source Handles (Right) */}
            {def?.handleConfig?.sources ? (
                def.handleConfig.sources.map((src, i) => (
                    <div key={src.id} className="relative group/handle">
                        <Handle
                            type="source"
                            position={Position.Right}
                            id={src.id}
                            title={src.label}
                            className={clsx(
                                "w-2.5 h-2.5 !bg-base-100 border-2 transition-all hover:scale-125 !-right-1.5 z-10 shadow-sm",
                                src.id === 'false' || src.id === 'done' ? 'border-error' : 'border-success'
                            )}
                            style={{ top: src.position || `${30 + i * 40}%` }}
                        />
                        {/* Hover Quick Add (+) button */}
                        <button
                            className="absolute -right-7 top-1/2 -translate-y-1/2 p-0.5 bg-primary text-primary-content rounded-full opacity-0 group-hover:opacity-100 focus:opacity-100 transition-opacity z-50 shadow-md hover:scale-110 active:scale-95"
                            style={{ top: src.position || `${30 + i * 40}%` }}
                            onClick={(e) => {
                                e.stopPropagation();
                                const rect = e.currentTarget.getBoundingClientRect();
                                const pane = document.querySelector('.react-flow__pane');
                                if (pane) {
                                    const paneRect = pane.getBoundingClientRect();
                                    const event = new CustomEvent('workflow-quick-add', {
                                        detail: {
                                            x: rect.left - paneRect.left,
                                            y: rect.top - paneRect.top,
                                            sourceNodeId: id || '',
                                            sourceHandleId: src.id
                                        }
                                    });
                                    window.dispatchEvent(event);
                                }
                            }}
                        >
                            <Plus size={12} />
                        </button>
                    </div>
                ))
            ) : (
                <div className="relative group/handle">
                    <Handle
                        type="source"
                        position={Position.Right}
                        className="w-2.5 h-2.5 !bg-base-100 border-2 border-primary !-right-1.5 transition-all hover:scale-125 z-10 shadow-sm"
                    />
                    <button
                        className="absolute -right-7 top-1/2 -translate-y-1/2 p-0.5 bg-primary text-primary-content rounded-full opacity-0 group-hover:opacity-100 focus:opacity-100 transition-opacity z-50 shadow-md hover:scale-110 active:scale-95"
                        onClick={(e) => {
                            e.stopPropagation();
                            const rect = e.currentTarget.getBoundingClientRect();
                            const pane = document.querySelector('.react-flow__pane');
                            if (pane) {
                                const paneRect = pane.getBoundingClientRect();
                                const event = new CustomEvent('workflow-quick-add', {
                                    detail: {
                                        x: rect.left - paneRect.left,
                                        y: rect.top - paneRect.top,
                                        sourceNodeId: id || '',
                                    }
                                });
                                window.dispatchEvent(event);
                            }
                        }}
                    >
                        <Plus size={12} />
                    </button>
                </div>
            )}
        </div>
    );
});



/* ============================================================
 *  Build nodeTypes map dynamically from registry
 * ============================================================ */
const nodeTypes: Record<string, any> = {};
NODE_DEFINITIONS.forEach(def => {
    nodeTypes[def.type] = GenericNode;
});


/* ============================================================
 *  Graph Context Menu
 * ============================================================ */
interface GraphContextMenuProps {
    type: 'node' | 'edge' | 'pane';
    x: number;
    y: number;
    onClose: () => void;
    onDelete?: () => void;
    onDuplicate?: () => void;
    onToFront?: () => void;
    onToBack?: () => void;
    onProperties?: () => void;
}

/* ============================================================
 *  Quick Add Menu (n8n Style)
 * ============================================================ */
interface QuickAddMenuProps {
    x: number;
    y: number;
    onAdd: (type: string) => void;
    onClose: () => void;
}

const QuickAddMenu: React.FC<QuickAddMenuProps> = ({ x, y, onAdd, onClose }) => {
    const [search, setSearch] = useState('');
    const inputRef = useRef<HTMLInputElement>(null);

    useEffect(() => {
        inputRef.current?.focus();
        const handleEsc = (e: KeyboardEvent) => { if (e.key === 'Escape') onClose(); };
        window.addEventListener('keydown', handleEsc);
        return () => window.removeEventListener('keydown', handleEsc);
    }, [onClose]);

    const filteredNodes = NODE_DEFINITIONS.filter(def =>
        def.label.toLowerCase().includes(search.toLowerCase()) ||
        def.type.toLowerCase().includes(search.toLowerCase())
    );

    return (
        <div
            className="absolute z-[100] bg-base-100 border border-base-300 shadow-2xl rounded-xl w-64 overflow-hidden animate-in fade-in zoom-in duration-150"
            style={{ left: x, top: y }}
        >
            <div className="p-3 border-b border-base-200">
                <div className="flex items-center gap-2 bg-base-200 px-2 rounded-lg">
                    <Braces size={14} className="text-base-content/40" />
                    <input
                        ref={inputRef}
                        type="text"
                        placeholder="Search nodes..."
                        className="bg-transparent border-none focus:ring-0 text-sm py-2 w-full"
                        value={search}
                        onChange={(e) => setSearch(e.target.value)}
                    />
                </div>
            </div>
            <div className="max-h-80 overflow-y-auto p-1">
                {filteredNodes.length > 0 ? (
                    filteredNodes.map(def => {
                        const Icon = def.icon;
                        return (
                            <button
                                key={def.type}
                                className="flex items-center gap-3 w-full p-2.5 hover:bg-primary/10 hover:text-primary rounded-lg transition-colors text-left group"
                                onClick={() => onAdd(def.type)}
                            >
                                <div className={clsx("p-1.5 rounded-md bg-base-200 group-hover:bg-primary/20", `text-${def.color}`)}>
                                    {Icon && <Icon size={16} />}
                                </div>
                                <div className="flex flex-col min-w-0 text-left">
                                    <span className="text-sm font-medium truncate">{def.label}</span>
                                    <span className="text-[10px] opacity-40 uppercase tracking-tighter">{def.group}</span>
                                </div>
                            </button>
                        );
                    })
                ) : (
                    <div className="p-4 text-center text-xs opacity-50 italic">No nodes found</div>
                )}
            </div>
            <div className="p-2 bg-base-200/50 text-[10px] text-center opacity-40 uppercase font-bold tracking-widest border-t border-base-200">
                Quick Add
            </div>
        </div>
    );
}

const GraphContextMenu: React.FC<GraphContextMenuProps> = ({ type, x, y, onClose, onDelete, onDuplicate, onToFront, onToBack, onProperties }) => {
    useEffect(() => {
        const handleClick = (_e: MouseEvent) => {
            // Prevent closing immediately if the click originated from opening the menu (if we weren't using a separate overlay)
            // But here we rely on the fact that this listener is attached after the context menu event
            onClose();
        };
        // Use timeout to avoid catching the initial click if it propagates? No, context menu event is separate.
        // But standard click outside pattern:
        window.addEventListener('click', handleClick);
        window.addEventListener('contextmenu', handleClick); // Close on right click elsewhere
        return () => {
            window.removeEventListener('click', handleClick);
            window.removeEventListener('contextmenu', handleClick);
        };
    }, [onClose]);

    return (
        <div
            className="fixed z-50 bg-base-100 shadow-xl border border-base-300 rounded-lg py-1 min-w-[160px] animate-in fade-in zoom-in-95 duration-100"
            style={{ left: x, top: y }}
            onClick={(e) => e.stopPropagation()} // Prevent closing when clicking inside
        >
            <div className="px-3 py-1.5 border-b border-base-200 text-[10px] font-bold opacity-40 uppercase tracking-wider">
                {type === 'node' ? 'Node Actions' : type === 'edge' ? 'Connection' : 'Canvas'}
            </div>

            {onProperties && (
                <button onClick={onProperties} className="w-full text-left px-4 py-2 hover:bg-base-200 text-xs flex items-center gap-2">
                    <Braces size={14} /> Properties
                </button>
            )}

            {onDuplicate && (
                <button onClick={onDuplicate} className="w-full text-left px-4 py-2 hover:bg-base-200 text-xs flex items-center gap-2">
                    <Plus size={14} /> Duplicate
                </button>
            )}

            {(onToFront || onToBack) && <div className="divider my-0 opacity-20" />}

            {onToFront && (
                <button onClick={onToFront} className="w-full text-left px-4 py-2 hover:bg-base-200 text-xs flex items-center gap-2">
                    <ChevronDown size={14} className="rotate-180" /> Bring to Front
                </button>
            )}

            {onToBack && (
                <button onClick={onToBack} className="w-full text-left px-4 py-2 hover:bg-base-200 text-xs flex items-center gap-2">
                    <ChevronDown size={14} /> Send to Back
                </button>
            )}

            {(onDelete) && <div className="divider my-0 opacity-20" />}

            {onDelete && (
                <button onClick={onDelete} className="w-full text-left px-4 py-2 hover:bg-error/10 text-error text-xs flex items-center gap-2">
                    <Trash2 size={14} /> Delete
                </button>
            )}
        </div>
    );
};

/* ============================================================
 *  Typed Properties Panel Components
 * ============================================================ */

interface ParamFieldProps {
    param: ParamSchema;
    value: any;
    onChange: (key: string, value: any) => void;
    expressionMode: boolean;
    onToggleExpression: () => void;
}

const ParamField: React.FC<ParamFieldProps> = ({
    param, value, onChange, expressionMode, onToggleExpression
}) => {
    if (expressionMode) {
        return (
            <div className="form-control w-full">
                <label className="label py-1">
                    <span className="text-[10px] uppercase font-bold opacity-50">{param.label}</span>
                    <button
                        className="btn btn-xs btn-ghost gap-1 text-warning"
                        onClick={onToggleExpression}
                        title="Switch to Fixed value"
                    >
                        <Braces size={10} /> Expr
                    </button>
                </label>
                <input
                    type="text"
                    className="input input-xs input-bordered font-mono text-warning bg-warning/5 border-warning/30"
                    value={value || ''}
                    onChange={(e) => onChange(param.key, e.target.value)}
                    placeholder={param.placeholder || '{{ $nodes["..."].output.xxx }}'}
                />
                {param.description && <div className="text-[9px] opacity-30 mt-0.5 pl-1">{param.description}</div>}
            </div>
        );
    }

    const commonLabel = (
        <label className="label py-1">
            <span className="text-[10px] uppercase font-bold opacity-50">
                {param.label} {param.required && <span className="text-error">*</span>}
            </span>
            <button
                className="btn btn-xs btn-ghost gap-1 opacity-30 hover:opacity-100"
                onClick={onToggleExpression}
                title="Switch to Expression"
            >
                <ToggleLeft size={10} />
            </button>
        </label>
    );

    switch (param.type) {
        case 'int':
        case 'float':
            return (
                <div className="form-control w-full">
                    {commonLabel}
                    <input
                        type="number"
                        className="input input-xs input-bordered"
                        value={value ?? param.defaultValue ?? ''}
                        onChange={(e) => onChange(param.key, param.type === 'int' ? parseInt(e.target.value) : parseFloat(e.target.value))}
                        min={param.min}
                        max={param.max}
                        step={param.type === 'float' ? 0.1 : 1}
                    />
                </div>
            );

        case 'string':
            return (
                <div className="form-control w-full">
                    {commonLabel}
                    <input
                        type="text"
                        className="input input-xs input-bordered"
                        value={value ?? ''}
                        onChange={(e) => onChange(param.key, e.target.value)}
                        placeholder={param.placeholder}
                    />
                </div>
            );

        case 'boolean':
            return (
                <div className="form-control w-full">
                    {commonLabel}
                    <input
                        type="checkbox"
                        className="toggle toggle-xs toggle-primary"
                        checked={!!value}
                        onChange={(e) => onChange(param.key, e.target.checked)}
                    />
                </div>
            );

        case 'select':
            return (
                <div className="form-control w-full">
                    {commonLabel}
                    <select
                        className="select select-xs select-bordered"
                        value={value ?? param.defaultValue ?? ''}
                        onChange={(e) => onChange(param.key, e.target.value)}
                    >
                        <option value="" disabled>Select...</option>
                        {param.options?.map(opt => (
                            <option key={opt.value} value={opt.value}>{opt.label}</option>
                        ))}
                    </select>
                </div>
            );

        case 'asset':
            return (
                <div className="form-control w-full">
                    {commonLabel}
                    <div className="flex gap-1">
                        <input
                            type="text"
                            className="input input-xs input-bordered flex-1 font-mono"
                            value={value ?? ''}
                            onChange={(e) => onChange(param.key, e.target.value)}
                            placeholder="images/button.png"
                        />
                    </div>
                    {param.description && <div className="text-[9px] opacity-30 mt-0.5 pl-1">{param.description}</div>}
                </div>
            );

        case 'region':
            return (
                <div className="form-control w-full">
                    {commonLabel}
                    <div className="grid grid-cols-2 gap-1">
                        <input type="number" className="input input-xs input-bordered" placeholder="x1" value={value?.x1 ?? ''} onChange={(e) => onChange(param.key, { ...value, x1: parseInt(e.target.value) })} />
                        <input type="number" className="input input-xs input-bordered" placeholder="y1" value={value?.y1 ?? ''} onChange={(e) => onChange(param.key, { ...value, y1: parseInt(e.target.value) })} />
                        <input type="number" className="input input-xs input-bordered" placeholder="x2" value={value?.x2 ?? ''} onChange={(e) => onChange(param.key, { ...value, x2: parseInt(e.target.value) })} />
                        <input type="number" className="input input-xs input-bordered" placeholder="y2" value={value?.y2 ?? ''} onChange={(e) => onChange(param.key, { ...value, y2: parseInt(e.target.value) })} />
                    </div>
                    <div className="text-[9px] opacity-30 mt-0.5 pl-1">x1, y1 (top-left) ??x2, y2 (bottom-right)</div>
                </div>
            );

        case 'expression':
            return (
                <div className="form-control w-full">
                    <label className="label py-1">
                        <span className="text-[10px] uppercase font-bold opacity-50">
                            {param.label} {param.required && <span className="text-error">*</span>}
                        </span>
                    </label>
                    <input
                        type="text"
                        className="input input-xs input-bordered font-mono text-warning bg-warning/5 border-warning/30"
                        value={value ?? ''}
                        onChange={(e) => onChange(param.key, e.target.value)}
                        placeholder={param.placeholder || '{{ ... }}'}
                    />
                    {param.description && <div className="text-[9px] opacity-30 mt-0.5 pl-1">{param.description}</div>}
                </div>
            );

        default:
            return null;
    }
};

/* ============================================================
 *  Props
 * ============================================================ */
interface WorkflowViewProps {
    tab: WorkflowTab;
    onContentChange?: (content: string) => void;
}

/* ============================================================
 *  Right Panel Tab Type
 * ============================================================ */
type RightPanelTab = 'properties' | 'variables';

/* ============================================================
 *  Inner Component (needs ReactFlowProvider)
 * ============================================================ */
function WorkflowViewInner({ tab, onContentChange }: WorkflowViewProps) {
    const { theme } = useAppStore();
    const [selectedNode, setSelectedNode] = useState<Node | null>(null);
    const { screenToFlowPosition, zoomIn, zoomOut, fitView, zoomTo } = useReactFlow();
    const [expandedCategories, setExpandedCategories] = useState<Record<string, boolean>>({
        platform: true, vision: true, flow: true
    });
    const [expressionModes, setExpressionModes] = useState<Record<string, boolean>>({});
    const [rightPanelTab, setRightPanelTab] = useState<RightPanelTab>('properties');
    const [showRightPanel, setShowRightPanel] = useState(false);
    const [newVarKey, setNewVarKey] = useState('');
    const [newVarValue, setNewVarValue] = useState('');
    const [isExecuting, setIsExecuting] = useState(false);



    // Context Menu State
    const [graphContextMenu, setGraphContextMenu] = useState<{
        type: 'node' | 'edge' | 'pane';
        x: number;
        y: number;
        id?: string;
        data?: any;
    } | null>(null);

    // n8n Quick Add State
    const [quickAddMenu, setQuickAddMenu] = useState<{
        x: number;
        y: number;
        sourceNodeId?: string;
        sourceHandleId?: string;
    } | null>(null);

    // Ref to handle connection end events
    const connectingNodeId = useRef<string | null>(null);
    const connectingHandleId = useRef<string | null>(null);


    // Clipboard for copy/paste
    const clipboardRef = useRef<Node[]>([]);

    // Handle Quick Add Event from Nodes
    useEffect(() => {
        const handleQuickAdd = (e: any) => {
            setQuickAddMenu({
                x: e.detail.x,
                y: e.detail.y,
                sourceNodeId: e.detail.sourceNodeId,
                sourceHandleId: e.detail.sourceHandleId
            });
        };
        window.addEventListener('workflow-quick-add', handleQuickAdd);
        return () => window.removeEventListener('workflow-quick-add', handleQuickAdd);
    }, []);

    // Parse workflow data from tab content
    const workflowData = useMemo(() => {
        try { return JSON.parse(tab.content); } catch { return { nodes: {}, edges: [], variables: {} }; }
    }, [tab.id]);

    // Convert backend format to React Flow format
    const initialNodes: Node[] = useMemo(() => {
        const nodesMap = workflowData.nodes || {};
        const nodeList = Object.values(nodesMap).map((n: any) => {
            const def = getNodeDef(n.type);
            let subtitle = '';
            if (n.config) {
                const entries = Object.entries(n.config).slice(0, 2);
                subtitle = entries.map(([k, v]) => `${k}: ${v}`).join(', ');
            }
            return {
                id: n.id,
                type: n.type || 'click',
                position: { x: n.x || 0, y: n.y || 0 },
                data: {
                    label: n.name || def?.label || 'Node',
                    nodeType: n.type,
                    config: n.config || {},
                    subtitle,
                    style: n.style, // Load style if exists
                },
            };
        });
        // Sort by z-index if we had it, but for now relies on array order
        return nodeList;
    }, [workflowData]);

    const initialEdges: Edge[] = useMemo(() => {
        const edgeArr = workflowData.edges || [];
        return edgeArr.map((e: any) => {
            const { stroke, strokeWidth } = e.style || {};
            return {
                id: e.id,
                source: e.fromNodeId || e.source,
                target: e.toNodeId || e.target,
                sourceHandle: e.signal && e.signal !== 'success' ? e.signal : undefined,
                label: e.signal || 'success',
                type: 'default',
                animated: isExecuting,
                className: isExecuting ? 'n8n-flow-active' : '',
                style: {
                    stroke: e.signal === 'false' ? '#ff52d9' : (isExecuting ? '#ff6d5a' : (stroke || '#94a3b8')),
                    strokeWidth: strokeWidth || 3
                },
                interactionWidth: 20,
                selectable: true,
                updatable: true,
            };
        });
    }, [workflowData, isExecuting]);

    const [nodes, setNodes, onNodesChange] = useNodesState(initialNodes);
    const [edges, setEdges, onEdgesChange] = useEdgesState(initialEdges);

    const onConnect = useCallback(
        (params: Connection) => {
            setEdges((eds) => addEdge({
                ...params,
                label: 'success',
                type: 'default', // n8n style Bezier
                animated: true,
                style: { strokeWidth: 3, stroke: '#94a3b8' },
                interactionWidth: 20,
                selectable: true,
                updatable: true,
            } as any, eds));
        },
        [setEdges]
    );

    const onConnectStart: OnConnectStart = useCallback((_, { nodeId, handleId }) => {
        connectingNodeId.current = nodeId;
        connectingHandleId.current = handleId;
    }, []);

    const onConnectEnd: OnConnectEnd = useCallback((event) => {
        if (!connectingNodeId.current) return;

        const targetIsPane = (event.target as Element).classList.contains('react-flow__pane');
        if (targetIsPane) {
            // Use screenToFlowPosition if we need world coordinates, but for the floating menu we use clientX/Y
            // const { x, y } = screenToFlowPosition({ x: (event as MouseEvent).clientX, y: (event as MouseEvent).clientY });

            setQuickAddMenu({
                x: (event as MouseEvent).clientX - 100, // Offset a bit
                y: (event as MouseEvent).clientY - 200,
                sourceNodeId: connectingNodeId.current || undefined,
                sourceHandleId: connectingHandleId.current || undefined,
            });
        }

        connectingNodeId.current = null;
        connectingHandleId.current = null;
    }, [screenToFlowPosition]);


    // Enhanced: Interaction Handlers
    const onNodeClick = useCallback((_: any, node: Node) => {
        setSelectedNode(node);
        // Don't open panel automatically
    }, []);

    const onNodeDoubleClick = useCallback((_: any, node: Node) => {
        setSelectedNode(node);
        setRightPanelTab('properties');
        setShowRightPanel(true);
    }, []);

    const onPaneClick = useCallback(() => {
        setSelectedNode(null);
        setGraphContextMenu(null);
        // Don't close panel automatically to allow keeping it open
    }, []);

    const onNodeContextMenu = useCallback((event: React.MouseEvent, node: Node) => {
        event.preventDefault();
        setSelectedNode(node); // Auto-select on right click
        setGraphContextMenu({
            type: 'node',
            x: event.clientX,
            y: event.clientY,
            id: node.id,
            data: node
        });
    }, []);

    const onEdgeContextMenu = useCallback((event: React.MouseEvent, edge: Edge) => {
        event.preventDefault();
        setGraphContextMenu({
            type: 'edge',
            x: event.clientX,
            y: event.clientY,
            id: edge.id
        });
    }, []);

    const onPaneContextMenu = useCallback((event: MouseEvent | React.MouseEvent) => {
        event.preventDefault();
        setGraphContextMenu({
            type: 'pane',
            x: event.clientX,
            y: event.clientY,
        });
    }, []);


    // Z-Index helpers
    const moveNodeToFront = useCallback(() => {
        if (!selectedNode) return;
        setNodes(nds => {
            const others = nds.filter(n => n.id !== selectedNode.id);
            const current = nds.find(n => n.id === selectedNode.id);
            return current ? [...others, current] : nds;
        });
        setGraphContextMenu(null);
    }, [selectedNode, setNodes]);

    const moveNodeToBack = useCallback(() => {
        if (!selectedNode) return;
        setNodes(nds => {
            const others = nds.filter(n => n.id !== selectedNode.id);
            const current = nds.find(n => n.id === selectedNode.id);
            return current ? [current, ...others] : nds;
        });
        setGraphContextMenu(null);
    }, [selectedNode, setNodes]);

    const handleDuplicate = useCallback(() => {
        if (selectedNode) {
            const offset = 20;
            const newNode = {
                ...selectedNode,
                id: uuidv4(),
                position: { x: selectedNode.position.x + offset, y: selectedNode.position.y + offset },
                selected: true,
                data: { ...selectedNode.data }
            };
            setNodes(nds => nds.map(n => ({ ...n, selected: false })).concat(newNode));
            setSelectedNode(newNode);
        }
        setGraphContextMenu(null);
    }, [selectedNode, setNodes]);

    const handleDeleteFromMenu = useCallback(() => {
        if (graphContextMenu?.type === 'node' && graphContextMenu.id) {
            const id = graphContextMenu.id;
            setNodes(nds => nds.filter(n => n.id !== id));
            setEdges(eds => eds.filter(e => e.source !== id && e.target !== id));
            if (selectedNode?.id === id) setSelectedNode(null);
        } else if (graphContextMenu?.type === 'edge' && graphContextMenu.id) {
            setEdges(eds => eds.filter(e => e.id !== graphContextMenu.id));
        }
        setGraphContextMenu(null);
    }, [graphContextMenu, setNodes, setEdges, selectedNode]);

    const handlePropertiesFromMenu = useCallback(() => {
        if (selectedNode) {
            setRightPanelTab('properties');
            setShowRightPanel(true);
        }
        setGraphContextMenu(null);
    }, [selectedNode]);


    const addConnectedNode = useCallback((nodeType: string, x: number, y: number, sourceId?: string, handleId?: string) => {
        const def = getNodeDef(nodeType);
        const newNodeId = uuidv4();
        const newNode: Node = {
            id: newNodeId,
            type: nodeType,
            position: { x, y },
            data: {
                label: def?.label || 'Node',
                nodeType,
                config: {},
                subtitle: '',
            },
        };

        setNodes((nds) => nds.concat(newNode));

        if (sourceId) {
            const newEdge: Edge = {
                id: uuidv4(),
                source: sourceId,
                target: newNodeId,
                sourceHandle: handleId,
                label: handleId === 'false' ? 'false' : 'success',
                ...DEFAULT_EDGE_OPTIONS
            };
            setEdges((eds) => addEdge(newEdge, eds));
        }

        setQuickAddMenu(null);
    }, [setNodes, setEdges]);


    // Sync graph state ??parent
    useEffect(() => {
        const nodesMap: Record<string, any> = {};
        nodes.forEach(n => {
            nodesMap[n.id] = {
                id: n.id,
                name: (n.data as any).label || '',
                type: n.type || 'click',
                config: (n.data as any).config || {},
                x: n.position.x,
                y: n.position.y,
                style: { width: n.width, height: n.height, ...n.style }, // Persist size
            };
        });
        const edgeArr = edges.map(e => ({
            id: e.id, fromNodeId: e.source, toNodeId: e.target,
            signal: e.sourceHandle || String(e.label || 'success'),
        }));
        const updated = { ...workflowData, nodes: nodesMap, edges: edgeArr };
        const json = JSON.stringify(updated, null, 2);
        if (json !== tab.content && onContentChange) onContentChange(json);
    }, [nodes, edges]);

    // Drag & Drop
    const onDragOver = useCallback((event: React.DragEvent) => {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
    }, []);

    const onDrop = useCallback((event: React.DragEvent) => {
        event.preventDefault();
        const type = event.dataTransfer.getData('application/reactflow');
        if (!type) return;
        const def = getNodeDef(type);
        const position = screenToFlowPosition({ x: event.clientX, y: event.clientY });
        const config = getDefaultConfig(type);
        const newNode: Node = {
            id: uuidv4(), type, position,
            data: { label: def?.label || 'Node', nodeType: type, config, subtitle: '' },
        };
        setNodes((nds) => nds.concat(newNode));
    }, [setNodes, screenToFlowPosition]);

    // Node config update
    const handleConfigChange = useCallback((key: string, value: any) => {
        if (!selectedNode) return;
        setNodes(nds => nds.map(n => {
            if (n.id !== selectedNode.id) return n;
            const newConfig = { ...(n.data as any).config, [key]: value };
            const entries = Object.entries(newConfig).filter(([, v]) => v !== undefined && v !== '').slice(0, 2);
            const subtitle = entries.map(([k, v]) => `${k}: ${v}`).join(', ');
            return { ...n, data: { ...n.data as any, config: newConfig, subtitle } };
        }));
        setSelectedNode(prev => {
            if (!prev) return null;
            const newConfig = { ...(prev.data as any).config, [key]: value };
            return { ...prev, data: { ...prev.data as any, config: newConfig } };
        });
    }, [selectedNode, setNodes]);

    /* ?€?€ Keyboard Shortcuts ?€?€?€?€?€?€?€?€?€?€?€?€?€?€?€?€?€?€?€?€?€?€?€?€?€?€?€?€?€?€?€ */
    const deleteSelectedNodes = useCallback(() => {
        const selectedIds = nodes.filter(n => n.selected).map(n => n.id);
        if (selectedIds.length === 0 && selectedNode) selectedIds.push(selectedNode.id);
        if (selectedIds.length === 0) return;
        setNodes(nds => nds.filter(n => !selectedIds.includes(n.id)));
        setEdges(eds => eds.filter(e => !selectedIds.includes(e.source) && !selectedIds.includes(e.target)));
        if (selectedNode && selectedIds.includes(selectedNode.id)) setSelectedNode(null);
    }, [nodes, selectedNode, setNodes, setEdges]);

    const copySelectedNodes = useCallback(() => {
        const sel = nodes.filter(n => n.selected);
        if (sel.length === 0 && selectedNode) sel.push(selectedNode);
        clipboardRef.current = sel.map(n => ({ ...n }));
    }, [nodes, selectedNode]);

    const pasteNodes = useCallback(() => {
        if (clipboardRef.current.length === 0) return;
        const offset = 40;
        const newNodes = clipboardRef.current.map(n => ({
            ...n,
            id: uuidv4(),
            position: { x: n.position.x + offset, y: n.position.y + offset },
            selected: false,
            data: { ...(n.data as any) },
        }));
        setNodes(nds => [...nds.map(n => ({ ...n, selected: false })), ...newNodes]);
    }, [setNodes]);

    const selectAllNodes = useCallback(() => {
        setNodes(nds => nds.map(n => ({ ...n, selected: true })));
    }, [setNodes]);

    useEffect(() => {
        const handler = (e: KeyboardEvent) => {
            // Don't capture shortcuts when typing in inputs
            const tag = (e.target as HTMLElement)?.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;
            if ((e.target as HTMLElement)?.contentEditable === 'true') return;

            // Delete / Backspace
            if (e.key === 'Delete' || e.key === 'Backspace') {
                e.preventDefault();
                deleteSelectedNodes();
            }
            // Ctrl+C / Cmd+C
            if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
                e.preventDefault();
                copySelectedNodes();
            }
            // Ctrl+V / Cmd+V
            if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
                e.preventDefault();
                pasteNodes();
            }
            // Ctrl+A / Cmd+A
            if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
                e.preventDefault();
                selectAllNodes();
            }
            // Ctrl+D / Cmd+D ??Duplicate
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                copySelectedNodes();
                pasteNodes();
            }
        };
        window.addEventListener('keydown', handler);
        return () => window.removeEventListener('keydown', handler);
    }, [deleteSelectedNodes, copySelectedNodes, pasteNodes, selectAllNodes]);

    // Variables CRUD helpers
    const getVars = useCallback((): Record<string, string> => {
        try { return JSON.parse(tab.content)?.variables || {}; } catch { return {}; }
    }, [tab.content]);

    const updateVars = useCallback((newVars: Record<string, string>) => {
        try {
            const data = JSON.parse(tab.content);
            data.variables = newVars;
            onContentChange?.(JSON.stringify(data, null, 2));
        } catch { /* ignore */ }
    }, [tab.content, onContentChange]);

    // Theme
    const flowColorMode = useMemo(() => {
        const lightThemes = ['light', 'cupcake', 'bumblebee', 'emerald', 'corporate', 'garden', 'lofi', 'pastel', 'fantasy', 'wireframe', 'cmyk', 'autumn', 'acid', 'lemonade', 'winter', 'nord'];
        return lightThemes.includes(theme) ? 'light' : 'dark';
    }, [theme]);
    const monacoTheme = useMemo(() => {
        const lightThemes = ['light', 'cupcake', 'bumblebee', 'emerald', 'corporate', 'garden', 'lofi', 'pastel', 'fantasy', 'wireframe', 'cmyk', 'autumn', 'acid', 'lemonade', 'winter', 'nord'];
        return lightThemes.includes(theme) ? 'light' : 'vs-dark';
    }, [theme]);

    const nodesByCategory = useMemo(() => getNodesByCategory(), []);
    const selectedNodeDef = selectedNode ? getNodeDef(selectedNode.type || '') : null;
    const vars = getVars();
    const varEntries = Object.entries(vars);

    return (
        <div className="flex-1 flex h-full bg-base-100 overflow-hidden">
            {tab.viewMode === 'graph' ? (
                <div className="flex-1 flex relative">
                    {/* Node Palette (3 categories) */}
                    <div className="w-56 border-r border-base-300 bg-base-200/50 p-2 flex flex-col gap-1 shrink-0 overflow-y-auto custom-scrollbar">
                        {(Object.keys(nodesByCategory) as NodeCategory[]).map(cat => (
                            <div key={cat}>
                                <button
                                    className="flex items-center gap-2 w-full px-2 py-1.5 rounded-md hover:bg-base-300/50 transition-colors"
                                    onClick={() => setExpandedCategories(prev => ({ ...prev, [cat]: !prev[cat] }))}
                                >
                                    <ChevronDown size={12} className={clsx("transition-transform", !expandedCategories[cat] && "-rotate-90")} />
                                    <span className={clsx("text-[10px] font-bold uppercase tracking-widest", CATEGORY_COLORS[cat])}>
                                        {CATEGORY_LABELS[cat]}
                                    </span>
                                    <span className="text-[9px] opacity-30 ml-auto">{nodesByCategory[cat].length}</span>
                                </button>

                                {expandedCategories[cat] && (
                                    <div className="ml-1 space-y-0.5 mb-2">
                                        {nodesByCategory[cat].map(def => {
                                            const IconComp = def.icon;
                                            return (
                                                <div
                                                    key={def.type}
                                                    draggable
                                                    onDragStart={(e) => {
                                                        e.dataTransfer.setData('application/reactflow', def.type);
                                                        e.dataTransfer.effectAllowed = 'move';
                                                    }}
                                                    className="group flex items-center gap-2 bg-base-100 border border-base-300 rounded-lg px-2.5 py-2 cursor-grab active:cursor-grabbing hover:border-primary/40 hover:shadow-sm transition-all"
                                                >
                                                    <GripVertical size={9} className="opacity-15 group-hover:opacity-40 shrink-0" />
                                                    <div className={clsx("p-1 rounded-md bg-base-200 group-hover:bg-primary/10 shrink-0", `text-${def.color}`)}>
                                                        <IconComp size={13} />
                                                    </div>
                                                    <div className="min-w-0 flex-1">
                                                        <div className="text-[11px] font-bold truncate">{def.label}</div>
                                                        <div className="text-[9px] opacity-35 truncate">{def.description}</div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    {/* React Flow Canvas */}
                    <div className="flex-1 relative">
                        <ReactFlow
                            nodes={nodes}
                            edges={edges}
                            onNodesChange={onNodesChange}
                            onEdgesChange={onEdgesChange}
                            onConnect={onConnect}
                            onNodeClick={onNodeClick}
                            onNodeDoubleClick={onNodeDoubleClick}
                            onNodeContextMenu={onNodeContextMenu}
                            onEdgeContextMenu={onEdgeContextMenu}
                            onPaneClick={onPaneClick}
                            onPaneContextMenu={onPaneContextMenu}
                            onDragOver={onDragOver}
                            onDrop={onDrop}
                            nodeTypes={nodeTypes}
                            fitView
                            colorMode={flowColorMode}
                            deleteKeyCode={null}
                            selectionOnDrag={true}
                            panOnDrag={PAN_ON_DRAG}
                            panOnScroll={true}
                            multiSelectionKeyCode={null}
                            selectionKeyCode={null}
                            defaultEdgeOptions={DEFAULT_EDGE_OPTIONS}
                            onConnectStart={onConnectStart}
                            onConnectEnd={onConnectEnd}
                        >
                            <Background gap={24} color="#f8fafc" />

                            {/* Global n8n Commands Panel */}
                            <div className="absolute bottom-6 left-1/2 -translate-x-1/2 z-10 flex flex-col items-center gap-4">
                                <button
                                    className={clsx(
                                        "btn btn-lg text-white border-none shadow-xl rounded-full px-8 gap-3 animate-in fade-in slide-in-from-bottom duration-300 group transition-all",
                                        isExecuting ? "bg-primary/50 cursor-not-allowed" : "bg-[#ff6d5a] hover:bg-[#ff5a45]"
                                    )}
                                    disabled={isExecuting}
                                    onClick={() => {
                                        if (isExecuting) return;
                                        setIsExecuting(true);

                                        // Mock Execution Sequence
                                        const nodeIds = nodes.map(n => n.id);
                                        let current = 0;

                                        const nextNode = () => {
                                            if (current >= nodeIds.length) {
                                                setTimeout(() => {
                                                    setIsExecuting(false);
                                                    setNodes(nds => nds.map(n => ({
                                                        ...n,
                                                        data: { ...n.data, status: 'success' }
                                                    })));
                                                }, 1000);
                                                return;
                                            }

                                            const id = nodeIds[current];
                                            setNodes(nds => nds.map(n => ({
                                                ...n,
                                                data: { ...n.data, status: n.id === id ? 'running' : n.data.status }
                                            })));

                                            setTimeout(() => {
                                                setNodes(nds => nds.map(n => ({
                                                    ...n,
                                                    data: { ...n.data, status: n.id === id ? 'success' : n.data.status }
                                                })));
                                                current++;
                                                nextNode();
                                            }, 800);
                                        };

                                        // Reset statuses
                                        setNodes(nds => nds.map(n => ({
                                            ...n,
                                            data: { ...n.data, status: undefined }
                                        })));

                                        nextNode();
                                    }}
                                >
                                    {isExecuting ? (
                                        <Loader2 size={20} className="animate-spin" />
                                    ) : (
                                        <Play size={20} fill="currentColor" className="group-hover:scale-110 transition-transform" />
                                    )}
                                    <span className="font-bold tracking-tight">
                                        {isExecuting ? 'Executing...' : 'Execute workflow'}
                                    </span>
                                </button>
                            </div>

                            {/* Floating Navigation Controls (n8n Style) */}
                            <div className="absolute top-1/2 -translate-y-1/2 right-4 z-10 flex flex-col gap-2 p-1.5 bg-base-100 border border-base-300 shadow-xl rounded-xl backdrop-blur-sm">
                                <button className="btn btn-sm btn-ghost btn-square text-base-content/60 hover:text-primary transition-colors" title="Zoom In" onClick={() => zoomIn()}>
                                    <Plus size={18} />
                                </button>
                                <button className="btn btn-sm btn-ghost btn-square text-base-content/60 hover:text-primary transition-colors" title="Zoom Out" onClick={() => zoomOut()}>
                                    <Minus size={18} />
                                </button>
                                <div className="h-px bg-base-300 mx-1" />
                                <button className="btn btn-sm btn-ghost btn-square text-base-content/60 hover:text-primary transition-colors" title="Zoom to Fit" onClick={() => fitView()}>
                                    <Focus size={18} />
                                </button>
                                <button className="btn btn-sm btn-ghost btn-square text-base-content/60 hover:text-primary transition-colors" title="Center View" onClick={() => zoomTo(1)}>
                                    <Maximize size={16} />
                                </button>
                            </div>
                            <Controls />
                            <MiniMap zoomable pannable />
                        </ReactFlow>

                        {/* Context Menu Overlay */}
                        {graphContextMenu && (
                            <GraphContextMenu
                                type={graphContextMenu.type}
                                x={graphContextMenu.x}
                                y={graphContextMenu.y}
                                onClose={() => setGraphContextMenu(null)}
                                onDelete={handleDeleteFromMenu}
                                onDuplicate={graphContextMenu.type === 'node' ? handleDuplicate : undefined}
                                onToFront={graphContextMenu.type === 'node' ? moveNodeToFront : undefined}
                                onToBack={graphContextMenu.type === 'node' ? moveNodeToBack : undefined}
                                onProperties={graphContextMenu.type === 'node' ? handlePropertiesFromMenu : undefined}
                            />
                        )}

                        {/* n8n Style Quick Add Menu */}
                        {quickAddMenu && (
                            <QuickAddMenu
                                x={quickAddMenu.x}
                                y={quickAddMenu.y}
                                onClose={() => setQuickAddMenu(null)}
                                onAdd={(type) => addConnectedNode(type, quickAddMenu.x, quickAddMenu.y, quickAddMenu.sourceNodeId, quickAddMenu.sourceHandleId)}
                            />
                        )}


                        {/* Floating Vars toggle */}
                        {!showRightPanel && (
                            <button
                                className="absolute top-3 right-3 btn btn-sm btn-ghost gap-1 bg-base-100/80 backdrop-blur border border-base-300 shadow-lg z-10"
                                onClick={() => { setRightPanelTab('variables'); setShowRightPanel(true); }}
                                title="Workflow Variables"
                            >
                                <Braces size={14} className="text-warning" /> Vars
                                {varEntries.length > 0 && (
                                    <span className="badge badge-xs badge-warning">{varEntries.length}</span>
                                )}
                            </button>
                        )}
                    </div>

                    {/* Right Sidebar Panel (Properties / Variables) */}
                    {showRightPanel && (
                        <div className="w-80 border-l border-base-300 bg-base-200/50 flex flex-col animate-in slide-in-from-right duration-200 overflow-hidden">
                            {/* Panel Tab Bar */}
                            <div className="flex items-center border-b border-base-300 shrink-0">
                                <button
                                    className={clsx(
                                        "flex-1 py-2 text-[10px] font-bold uppercase tracking-wider transition-colors",
                                        rightPanelTab === 'properties'
                                            ? "text-primary border-b-2 border-primary bg-primary/5"
                                            : "text-base-content/40 hover:text-base-content/60"
                                    )}
                                    onClick={() => setRightPanelTab('properties')}
                                >
                                    Properties
                                </button>
                                <button
                                    className={clsx(
                                        "flex-1 py-2 text-[10px] font-bold uppercase tracking-wider transition-colors flex items-center justify-center gap-1",
                                        rightPanelTab === 'variables'
                                            ? "text-warning border-b-2 border-warning bg-warning/5"
                                            : "text-base-content/40 hover:text-base-content/60"
                                    )}
                                    onClick={() => setRightPanelTab('variables')}
                                >
                                    <Braces size={10} /> Variables
                                    {varEntries.length > 0 && <span className="badge badge-xs badge-warning ml-1">{varEntries.length}</span>}
                                </button>
                                <button className="btn btn-xs btn-ghost btn-square mx-1" onClick={() => setShowRightPanel(false)}>
                                    <X size={14} />
                                </button>
                            </div>

                            {/* Properties Tab */}
                            {rightPanelTab === 'properties' && (
                                selectedNode && selectedNodeDef ? (
                                    <>
                                        {/* Node Header */}
                                        <div className="flex items-center gap-2 px-4 py-3 border-b border-base-300 shrink-0">
                                            {(() => { const IC = selectedNodeDef.icon; return <IC size={16} className={`text-${selectedNodeDef.color}`} />; })()}
                                            <div className="min-w-0 flex-1">
                                                <div className="text-xs font-bold">{selectedNodeDef.label}</div>
                                                <div className="text-[9px] opacity-40">{selectedNodeDef.description}</div>
                                            </div>
                                        </div>

                                        {/* Scrollable Content */}
                                        <div className="flex-1 overflow-y-auto px-4 py-3 space-y-1 custom-scrollbar">
                                            {/* Node Name */}
                                            <div className="form-control w-full">
                                                <label className="label py-1">
                                                    <span className="text-[10px] uppercase font-bold opacity-50">Name</span>
                                                </label>
                                                <input
                                                    type="text"
                                                    className="input input-xs input-bordered"
                                                    value={(selectedNode.data as any).label}
                                                    onChange={(e) => {
                                                        setNodes(nds => nds.map(n => n.id === selectedNode.id
                                                            ? { ...n, data: { ...n.data as any, label: e.target.value } } : n));
                                                        setSelectedNode(prev => prev ? { ...prev, data: { ...prev.data as any, label: e.target.value } } : null);
                                                    }}
                                                />
                                            </div>

                                            {/* Node ID */}
                                            <div className="form-control w-full">
                                                <label className="label py-1">
                                                    <span className="text-[10px] uppercase font-bold opacity-50">ID</span>
                                                </label>
                                                <input type="text" value={selectedNode.id} readOnly
                                                    className="input input-xs input-bordered bg-base-300/50 font-mono text-[10px] opacity-40 cursor-not-allowed" />
                                            </div>

                                            {selectedNodeDef.params.length > 0 && (
                                                <div className="divider text-[9px] opacity-30 uppercase tracking-widest my-2">Parameters</div>
                                            )}

                                            {selectedNodeDef.params.map(param => {
                                                const exprKey = `${selectedNode.id}:${param.key}`;
                                                return (
                                                    <ParamField
                                                        key={param.key}
                                                        param={param}
                                                        value={(selectedNode.data as any).config?.[param.key]}
                                                        onChange={handleConfigChange}
                                                        expressionMode={!!expressionModes[exprKey]}
                                                        onToggleExpression={() => setExpressionModes(prev => ({
                                                            ...prev, [exprKey]: !prev[exprKey]
                                                        }))}
                                                    />
                                                );
                                            })}

                                            {selectedNodeDef.outputs.length > 0 && (
                                                <>
                                                    <div className="divider text-[9px] opacity-30 uppercase tracking-widest my-2">Outputs</div>
                                                    <div className="space-y-1">
                                                        {selectedNodeDef.outputs.map(out => (
                                                            <div key={out.key} className="flex items-center justify-between py-1 px-2 bg-base-300/30 rounded-md">
                                                                <span className="text-[10px] font-mono opacity-60">{out.key}</span>
                                                                <span className="badge badge-xs badge-ghost font-mono">{out.type}</span>
                                                            </div>
                                                        ))}
                                                        <div className="text-[9px] opacity-30 px-2 mt-1">
                                                            Reference: <code className="text-warning">{'{{ $nodes["' + (selectedNode.data as any).label + '"].output.' + selectedNodeDef.outputs[0]?.key + ' }}'}</code>
                                                        </div>
                                                    </div>
                                                </>
                                            )}
                                        </div>

                                        {/* Footer Actions */}
                                        <div className="border-t border-base-300 p-3 shrink-0">
                                            <button
                                                className="btn btn-sm btn-error btn-outline gap-2 w-full"
                                                onClick={() => {
                                                    setNodes(nds => nds.filter(n => n.id !== selectedNode.id));
                                                    setEdges(eds => eds.filter(e => e.source !== selectedNode.id && e.target !== selectedNode.id));
                                                    setSelectedNode(null);
                                                }}
                                            >
                                                <Trash2 size={14} /> Delete Node
                                            </button>
                                        </div>
                                    </>
                                ) : (
                                    <div className="flex-1 flex flex-col items-center justify-center text-base-content/20 p-8 text-center">
                                        <div className="text-sm">Select a node</div>
                                        <div className="text-[10px] mt-1 opacity-60">Double-click or right-click to view properties</div>
                                    </div>
                                )
                            )}

                            {/* Variables Tab */}
                            {rightPanelTab === 'variables' && (
                                <div className="flex-1 overflow-y-auto px-4 py-3 custom-scrollbar">
                                    <p className="text-[10px] opacity-40 mb-3">
                                        Global variables for this workflow. Reference via <code className="text-warning">{'{{ $vars.key }}'}</code>
                                    </p>

                                    <div className="space-y-2">
                                        {varEntries.map(([k, v]) => (
                                            <div key={k} className="flex items-center gap-1.5">
                                                <input
                                                    type="text" value={k} readOnly
                                                    className="input input-xs input-bordered w-24 font-mono bg-base-200 cursor-not-allowed shrink-0"
                                                />
                                                <input
                                                    type="text" value={v}
                                                    className="input input-xs input-bordered flex-1 font-mono"
                                                    onChange={(e) => updateVars({ ...vars, [k]: e.target.value })}
                                                />
                                                <button
                                                    className="btn btn-xs btn-ghost btn-square text-error shrink-0"
                                                    onClick={() => {
                                                        const newVars = { ...vars };
                                                        delete newVars[k];
                                                        updateVars(newVars);
                                                    }}
                                                >
                                                    <Trash2 size={12} />
                                                </button>
                                            </div>
                                        ))}

                                        {varEntries.length === 0 && (
                                            <div className="text-center text-xs opacity-20 py-6">No variables defined</div>
                                        )}

                                        <div className="divider text-[9px] opacity-20 my-1">Add</div>
                                        <div className="flex items-center gap-1.5">
                                            <input
                                                type="text" placeholder="key"
                                                className="input input-xs input-bordered w-24 font-mono shrink-0"
                                                value={newVarKey}
                                                onChange={(e) => setNewVarKey(e.target.value)}
                                                onKeyDown={(e) => {
                                                    if (e.key === 'Enter' && newVarKey.trim()) {
                                                        updateVars({ ...vars, [newVarKey.trim()]: newVarValue });
                                                        setNewVarKey('');
                                                        setNewVarValue('');
                                                    }
                                                }}
                                            />
                                            <input
                                                type="text" placeholder="value"
                                                className="input input-xs input-bordered flex-1 font-mono"
                                                value={newVarValue}
                                                onChange={(e) => setNewVarValue(e.target.value)}
                                                onKeyDown={(e) => {
                                                    if (e.key === 'Enter' && newVarKey.trim()) {
                                                        updateVars({ ...vars, [newVarKey.trim()]: newVarValue });
                                                        setNewVarKey('');
                                                        setNewVarValue('');
                                                    }
                                                }}
                                            />
                                            <button
                                                className="btn btn-xs btn-primary btn-square shrink-0"
                                                onClick={() => {
                                                    if (!newVarKey.trim()) return;
                                                    updateVars({ ...vars, [newVarKey.trim()]: newVarValue });
                                                    setNewVarKey('');
                                                    setNewVarValue('');
                                                }}
                                                disabled={!newVarKey.trim()}
                                            >
                                                <Plus size={12} />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            ) : (
                /* YAML / JSON Editor View */
                <div className="flex-1">
                    <Editor
                        height="100%"
                        defaultLanguage="json"
                        value={tab.content}
                        theme={monacoTheme}
                        options={{
                            minimap: { enabled: false }, fontSize: 14,
                            automaticLayout: true, lineNumbers: 'on',
                            roundedSelection: true, scrollBeyondLastLine: false,
                        }}
                        onChange={(val) => onContentChange?.(val || "")}
                    />
                </div>
            )}
        </div>
    );
}

/* ============================================================
 *  Exported Wrapper
 * ============================================================ */
export const WorkflowView: React.FC<WorkflowViewProps> = (props) => (
    <ReactFlowProvider>
        <WorkflowViewInner {...props} />
    </ReactFlowProvider>
);
