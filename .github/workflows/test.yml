name: Comprehensive Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          go mod tidy
          pip install -r requirements.txt
          pip install pytest allure-pytest
          cd frontend && npm install
          npx playwright install --with-deps chromium

      - name: Run Backend Tests (Go)
        run: |
          go install github.com/jstemmer/go-junit-report/v2@latest
          mkdir -p allure-results
          go test -v ./server/... 2>&1 | go-junit-report -set-exit-code > allure-results/go-test-report.xml

      - name: Run Core Tests (Python)
        run: |
          $env:PYTHONPATH="."
          pytest core/test --alluredir=allure-results

      - name: Run Frontend Tests (Playwright)
        run: |
          cd frontend
          npm run test:e2e
        env:
          # Playwright config will output to ../allure-results because of its config
          ALLURE_RESULTS_DIR: ../allure-results

      - name: Get Allure history
        uses: actions/checkout@v4
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Allure Report action from GitHub
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: allure-results
          gh_pages: gh-pages
          allure_report: allure-report
          allure_history: allure-history

      - name: Deploy report to Github Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history
